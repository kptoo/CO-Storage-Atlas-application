<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CO‚ÇÇ Storage Atlas for Upper Austria & Salzburg - Interactive geospatial mapping of CO‚ÇÇ emission sources and storage suitability">
    <meta name="keywords" content="CO2, carbon storage, Austria, Salzburg, environmental, geospatial, GIS, climate">
    <meta name="author" content="CO‚ÇÇ Storage Atlas Team">
    <title>CO‚ÇÇ Storage Atlas - Upper Austria & Salzburg</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="css/styles.css" as="style">
    <link rel="preload" href="js/app.js" as="script">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""
          media="all">
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
          media="all">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
          media="all">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css" media="all">
    
    <!-- Favicon and icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåç</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåç</text></svg>">
    
    <!-- Open Graph meta tags -->
    <meta property="og:title" content="CO‚ÇÇ Storage Atlas - Upper Austria & Salzburg">
    <meta property="og:description" content="Interactive geospatial mapping of CO‚ÇÇ emission sources and storage suitability">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/icons/CO‚ÇÇ Sources.png">
    
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="CO‚ÇÇ Storage Atlas">
    <meta name="twitter:description" content="Interactive CO‚ÇÇ emission mapping for Austria">
</head>
<body>
    <!-- Map Container - Full Screen -->
    <div id="map" role="main" aria-label="Interactive CO‚ÇÇ Storage Atlas Map"></div>

    <!-- Enhanced Control Panel -->
    <div class="control-panel" id="control-panel" role="complementary" aria-label="Map Controls">
        <div class="panel-header">
            <h1>Map Layers</h1>
            <button class="panel-toggle" id="panel-toggle" 
                    title="Toggle Panel" 
                    aria-label="Toggle control panel"
                    aria-expanded="true">
                <span class="toggle-icon">‚àí</span>
            </button>
        </div>
        
        <!-- Scrollable Content Area -->
        <div class="panel-content">
            <!-- Data Quality Indicator -->
            <section class="data-quality" id="data-quality" aria-labelledby="data-status-heading">
                <h2 id="data-status-heading">Data Status</h2>
                <div class="quality-item">
                    <span class="quality-label">Database:</span>
                    <span class="quality-status" id="db-status" aria-live="polite">Checking...</span>
                </div>
                <div class="quality-item">
                    <span class="quality-label">Layers:</span>
                    <span class="quality-status" id="layers-status" aria-live="polite">0/14 loaded</span>
                </div>
            </section>
            
            <!-- Primary Layers -->
            <section class="layer-controls" aria-labelledby="primary-data-heading">
                <h2 id="primary-data-heading">Primary Data</h2>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-voting" checked 
                           aria-describedby="voting-desc">
                    <label for="layer-voting">
                        <span class="layer-name">Left+Green Voting Share</span>
                        <span class="layer-count" id="voting-count">(0)</span>
                    </label>
                    <div class="layer-legend gradient-legend voting-legend" 
                         id="voting-desc"
                         title="Gray: No data, Orange to Green: Low to High left+green support"
                         aria-label="Voting preference color scale"></div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-co2-sources" checked
                           aria-describedby="co2-desc">
                    <label for="layer-co2-sources">
                        <span class="layer-name">CO‚ÇÇ Emission Sources</span>
                        <span class="layer-count" id="co2-count">(0)</span>
                    </label>
                    <div class="layer-legend layer-icon" id="co2-desc" 
                         title="Industrial CO‚ÇÇ emission sources with clustering"
                         aria-label="CO‚ÇÇ sources icon">
                        <img src="icons/CO‚ÇÇ Sources.png" alt="CO‚ÇÇ Sources" class="legend-icon" loading="lazy">
                    </div>
                </div>
            </section>

            <!-- Infrastructure Layers -->
            <section class="layer-controls" aria-labelledby="infrastructure-heading">
                <h2 id="infrastructure-heading">Infrastructure</h2>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-landfills">
                    <label for="layer-landfills">
                        <span class="layer-name">Landfills</span>
                        <span class="layer-count" id="landfills-count">(0)</span>
                    </label>
                    <div class="layer-legend layer-icon">
                        <img src="icons/Landfills.png" alt="Landfills" class="legend-icon" loading="lazy">
                    </div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-gravel-pits">
                    <label for="layer-gravel-pits">
                        <span class="layer-name">Gravel Pits & Quarries</span>
                        <span class="layer-count" id="gravel-count">(0)</span>
                    </label>
                    <div class="layer-legend layer-icon">
                        <img src="icons/Gravel Pits.png" alt="Gravel Pits" class="legend-icon" loading="lazy">
                    </div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-wastewater">
                    <label for="layer-wastewater">
                        <span class="layer-name">Wastewater Plants</span>
                        <span class="layer-count" id="wastewater-count">(0)</span>
                    </label>
                    <div class="layer-legend layer-icon">
                        <img src="icons/Wastewater Plants.png" alt="Wastewater Plants" class="legend-icon" loading="lazy">
                    </div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-gas-pipelines">
                    <label for="layer-gas-pipelines">
                        <span class="layer-name">Gas Pipeline Network</span>
                        <span class="layer-count" id="pipelines-count">(0)</span>
                    </label>
                    <div class="layer-legend line-legend" 
                         style="background: #00aa44; height: 4px; border-radius: 2px;" 
                         aria-label="Gas pipeline line style"></div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-gas-storage">
                    <label for="layer-gas-storage">
                        <span class="layer-name">Gas Storage Sites</span>
                        <span class="layer-count" id="storage-count">(0)</span>
                    </label>
                    <div class="layer-legend layer-icon">
                        <img src="icons/Gas Storage.png" alt="Gas Storage" class="legend-icon" loading="lazy">
                    </div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-gas-distribution">
                    <label for="layer-gas-distribution">
                        <span class="layer-name">Gas Distribution Points</span>
                        <span class="layer-count" id="distribution-count">(0)</span>
                    </label>
                    <div class="layer-legend layer-icon">
                        <img src="icons/Gas Distribution.png" alt="Gas Distribution" class="legend-icon" loading="lazy">
                    </div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-compressor-stations">
                    <label for="layer-compressor-stations">
                        <span class="layer-name">Compressor Stations</span>
                        <span class="layer-count" id="compressor-count">(0)</span>
                    </label>
                    <div class="layer-legend layer-icon">
                        <img src="icons/Compressor Stations.png" alt="Compressor Stations" class="legend-icon" loading="lazy">
                    </div>
                </div>
            </section>

            <!-- Transport Infrastructure -->
            <section class="layer-controls" aria-labelledby="transport-heading">
                <h2 id="transport-heading">Transport Network</h2>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-highways">
                    <label for="layer-highways">
                        <span class="layer-name">Primary Roads</span>
                        <span class="layer-count" id="highways-count">(0)</span>
                    </label>
                    <div class="layer-legend line-legend" 
                         style="background: #666666; height: 3px; border-radius: 2px;"
                         aria-label="Highway line style"></div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-railways">
                    <label for="layer-railways">
                        <span class="layer-name">Railway Lines</span>
                        <span class="layer-count" id="railways-count">(0)</span>
                    </label>
                    <div class="layer-legend line-legend dashed" 
                         style="background: #8B4513; height: 3px; border-radius: 2px;"
                         aria-label="Railway dashed line style"></div>
                </div>
            </section>

            <!-- Unsuitable Areas -->
            <section class="layer-controls" aria-labelledby="unsuitable-heading">
                <h2 id="unsuitable-heading">Unsuitable Areas for CO‚ÇÇ Storage</h2>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-settlements">
                    <label for="layer-settlements">
                        <span class="layer-name">Residential Areas</span>
                        <span class="layer-count" id="settlements-count">(0)</span>
                    </label>
                    <div class="layer-legend area-legend" 
                         style="background: rgba(255, 0, 0, 0.3); border: 2px solid #cc0000;"
                         aria-label="Residential area style"></div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-conservation">
                    <label for="layer-conservation">
                        <span class="layer-name">Nature Conservation</span>
                        <span class="layer-count" id="conservation-count">(0)</span>
                    </label>
                    <div class="layer-legend area-legend" 
                         style="background: rgba(0, 255, 0, 0.3); border: 2px solid #00cc00;"
                         aria-label="Conservation area style"></div>
                </div>
                
                <div class="layer-control">
                    <input type="checkbox" id="layer-groundwater">
                    <label for="layer-groundwater">
                        <span class="layer-name">Groundwater Protection</span>
                        <span class="layer-count" id="groundwater-count">(0)</span>
                    </label>
                    <div class="layer-legend area-legend" 
                         style="background: rgba(0, 102, 255, 0.3); border: 2px solid #0044cc;"
                         aria-label="Groundwater protection area style"></div>
                </div>
            </section>

            <!-- Layer Management Tools -->
            <section class="layer-management" aria-labelledby="layer-tools-heading">
                <h2 id="layer-tools-heading">Layer Tools</h2>
                <div class="tool-buttons" role="group" aria-labelledby="layer-tools-heading">
                    <button class="btn btn-small" id="show-all-layers" 
                            title="Enable all layers"
                            aria-label="Show all map layers">Show All</button>
                    <button class="btn btn-small" id="hide-all-layers" 
                            title="Disable all layers"
                            aria-label="Hide all map layers">Hide All</button>
                    <button class="btn btn-small" id="refresh-data" 
                            title="Reload data from server"
                            aria-label="Refresh map data">Refresh</button>
                </div>
            </section>

            <!-- Performance Settings -->
            <section class="performance-settings" aria-labelledby="performance-heading">
                <h2 id="performance-heading">Performance</h2>
                <div class="performance-controls">
                    <label class="toggle-switch">
                        <input type="checkbox" id="clustering-enabled" checked>
                        <span class="slider">Enable Clustering</span>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="performance-mode" checked>
                        <span class="slider">Performance Mode</span>
                    </label>
                </div>
            </section>

            <!-- Base Map Control -->
            <section class="basemap-section" aria-labelledby="basemap-heading">
                <h2 id="basemap-heading">Base Map</h2>
                <div class="basemap-controls">
                    <select id="basemap-selector" aria-label="Select base map">
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">Satellite Imagery</option>
                        <option value="terrain">Terrain Map</option>
                    </select>
                </div>
            </section>

            <!-- Statistics Panel -->
            <section class="statistics-panel" id="statistics-panel" aria-labelledby="statistics-heading">
                <h2 id="statistics-heading">Map Statistics</h2>
                <div class="stat-item">
                    <span class="stat-label">Total Features:</span>
                    <span class="stat-value" id="total-features" aria-live="polite">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Visible Layers:</span>
                    <span class="stat-value" id="visible-layers" aria-live="polite">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Map Zoom:</span>
                    <span class="stat-value" id="current-zoom" aria-live="polite">8</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Clusters Active:</span>
                    <span class="stat-value" id="active-clusters" aria-live="polite">4</span>
                </div>
            </section>

            <!-- Authentication Section -->
            <section class="auth-section" aria-labelledby="admin-heading">
                <h2 id="admin-heading">Admin Access</h2>
                <div class="auth-form" id="auth-form">
                    <input type="password" id="admin-password" 
                           placeholder="Enter admin password"
                           aria-label="Admin password">
                    <button class="btn btn-primary" id="admin-login-btn"
                            aria-label="Login as administrator">Login</button>
                </div>
                <div class="auth-status" id="auth-status" style="display: none;">
                    <span class="auth-indicator" aria-hidden="true"></span>
                    <span class="auth-text">Admin Mode</span>
                    <button class="btn btn-small" id="admin-logout-btn"
                            aria-label="Logout from admin mode">Logout</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Admin Panel (Hidden by default) -->
    <div id="admin-panel" class="admin-panel" role="dialog" aria-hidden="true" aria-labelledby="admin-panel-heading">
        <div class="admin-header">
            <h2 id="admin-panel-heading">Admin Panel</h2>
            <button class="btn btn-small" id="close-admin-panel" 
                    aria-label="Close admin panel">√ó</button>
        </div>
        
        <div class="admin-tabs" role="tablist">
            <div class="admin-tab active" data-tab="co2" role="tab" 
                 aria-selected="true" tabindex="0">CO‚ÇÇ Sources</div>
            <div class="admin-tab" data-tab="layers" role="tab" 
                 aria-selected="false" tabindex="-1">Layer Management</div>
            <div class="admin-tab" data-tab="database" role="tab" 
                 aria-selected="false" tabindex="-1">Database</div>
        </div>

        <!-- CO2 Sources Form -->
        <div id="admin-form-co2" class="admin-form active" role="tabpanel">
            <h3>Add/Edit CO‚ÇÇ Source</h3>
            <form id="co2-form" novalidate>
                <input type="hidden" id="co2-id">
                <input type="text" id="co2-plant-name" placeholder="Plant Name" required 
                       aria-label="Plant name">
                <select id="co2-plant-type" required aria-label="Plant type">
                    <option value="">Select Type</option>
                    <option value="Waste-to-energy plant">Waste-to-energy plant</option>
                    <option value="Biomethane plant">Biomethane plant</option>
                    <option value="Paper mill">Paper mill</option>
                    <option value="Cement plant">Cement plant</option>
                    <option value="Chemical plant">Chemical plant</option>
                    <option value="Steel mill">Steel mill</option>
                    <option value="Power plant">Power plant</option>
                    <option value="Industrial facility">Industrial facility</option>
                </select>
                <input type="number" id="co2-total" placeholder="Total CO‚ÇÇ (t/year)" 
                       min="0" step="100" aria-label="Total CO‚ÇÇ emissions per year">
                <input type="number" id="co2-fossil" placeholder="Fossil CO‚ÇÇ (t/year)" 
                       min="0" step="100" aria-label="Fossil CO‚ÇÇ emissions per year">
                <input type="number" id="co2-biogenic" placeholder="Biogenic CO‚ÇÇ (t/year)" 
                       min="0" step="100" aria-label="Biogenic CO‚ÇÇ emissions per year">
                <input type="number" id="co2-latitude" placeholder="Latitude (WGS84)" 
                       step="0.000001" min="46" max="49" required aria-label="Latitude coordinate">
                <input type="number" id="co2-longitude" placeholder="Longitude (WGS84)" 
                       step="0.000001" min="9" max="17" required aria-label="Longitude coordinate">
                <textarea id="co2-comment" placeholder="Comment or description" 
                          rows="3" aria-label="Additional comments"></textarea>
                
                <div class="coordinate-tools">
                    <button type="button" class="btn btn-small" id="get-coordinates">
                        Click Map for Coordinates
                    </button>
                    <button type="button" class="btn btn-small" id="validate-coordinates">
                        Validate
                    </button>
                </div>
                
                <div class="existing-sources">
                    <h4>Existing Sources (Click to Edit)</h4>
                    <div class="sources-list" id="sources-list">
                        <p>Loading existing sources...</p>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" id="save-co2">Save</button>
                    <button type="button" class="btn btn-secondary" id="clear-co2">Clear</button>
                    <button type="button" class="btn btn-danger" id="delete-co2" style="display: none;">Delete</button>
                </div>
            </form>
        </div>

        <!-- Layer Management Form -->
        <div id="admin-form-layers" class="admin-form" role="tabpanel">
            <h3>Layer Management</h3>
            <div class="layer-edit-list" id="layer-edit-list">
                <p>Layer management tools for existing data only.</p>
                <p>Use the map interface to visualize and interact with layers.</p>
            </div>
            <div class="layer-actions">
                <button class="btn btn-primary" id="refresh-layer-list">Refresh View</button>
                <button class="btn btn-secondary" id="toggle-all-layers">Toggle All</button>
            </div>
        </div>

        <!-- Database Management Form -->
        <div id="admin-form-database" class="admin-form" role="tabpanel">
            <h3>Database Management</h3>
            <div class="database-stats" id="database-stats">
                <p>Loading database statistics...</p>
            </div>
            <div class="database-actions">
                <button class="btn btn-primary" id="refresh-stats">Refresh Stats</button>
                <button class="btn btn-secondary" id="optimize-database">Optimize Database</button>
                <button class="btn btn-warning" id="backup-database">Create Backup</button>
            </div>
            <div class="optimization-results" id="optimization-results">
                <h4>Optimization Results</h4>
                <div class="results-content" role="log" aria-live="polite"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" role="dialog" aria-labelledby="loading-title">
        <div class="loading-content">
            <div class="spinner" role="progressbar" aria-label="Loading application"></div>
            <h2 id="loading-title">Loading CO‚ÇÇ Storage Atlas</h2>
            <p id="loading-status" aria-live="polite">Initializing application...</p>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" 
                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <span class="progress-text" id="progress-text" aria-live="polite">0%</span>
            </div>
        </div>
    </div>

    <!-- Toast Container for Notifications -->
    <div id="toast-container" class="toast-container" 
         role="region" aria-label="Notifications" aria-live="polite"></div>

    <!-- Map Click Coordinates Display -->
    <div id="coordinates-display" class="coordinates-display">
        <span id="coordinates-text">Click on map to get coordinates</span>
        <button id="close-coordinates" aria-label="Close coordinates display">√ó</button>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin="" defer></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" defer></script>
    
    <!-- Custom JavaScript -->
    <script src="js/app.js" defer></script>
    
    <!-- Initialization Script -->
    <script>
        // Application initialization with error handling
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåç DOM Content Loaded - Setting up application...');
            
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet not loaded');
                document.getElementById('loading-status').textContent = 'Error: Leaflet library not loaded';
                return;
            }
            
            // Check for MarkerCluster
            if (typeof L.markerClusterGroup === 'undefined') {
                console.warn('Leaflet MarkerCluster plugin not loaded, clustering disabled');
            }
            
            // Initialize UI handlers after atlas is ready
            const initializeUIHandlers = () => {
                if (!window.atlas) {
                    setTimeout(initializeUIHandlers, 100);
                    return;
                }
                
                console.log('üìã Setting up UI event handlers...');
                
                // Panel toggle handler
                const setupPanelToggle = () => {
                    const panelToggle = document.getElementById('panel-toggle');
                    const controlPanel = document.getElementById('control-panel');
                    
                    if (!panelToggle || !controlPanel) {
                        console.warn('Panel toggle elements not found');
                        return;
                    }
                    
                    panelToggle.removeEventListener('click', handlePanelToggle);
                    panelToggle.addEventListener('click', handlePanelToggle);
                    
                    function handlePanelToggle(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const toggleIcon = panelToggle.querySelector('.toggle-icon');
                        const isCollapsed = controlPanel.classList.contains('collapsed');
                        
                        if (isCollapsed) {
                            controlPanel.classList.remove('collapsed');
                            if (toggleIcon) toggleIcon.textContent = '‚àí';
                            panelToggle.setAttribute('aria-expanded', 'true');
                        } else {
                            controlPanel.classList.add('collapsed');
                            if (toggleIcon) toggleIcon.textContent = '+';
                            panelToggle.setAttribute('aria-expanded', 'false');
                        }
                        
                        localStorage.setItem('controlPanelCollapsed', controlPanel.classList.contains('collapsed'));
                    }
                };
                
                setupPanelToggle();
                
                // Admin tab functionality
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        document.querySelectorAll('.admin-tab').forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                            t.setAttribute('tabindex', '-1');
                        });
                        document.querySelectorAll('.admin-form').forEach(f => f.classList.remove('active'));
                        
                        this.classList.add('active');
                        this.setAttribute('aria-selected', 'true');
                        this.setAttribute('tabindex', '0');
                        
                        const formId = 'admin-form-' + this.dataset.tab;
                        const form = document.getElementById(formId);
                        if (form) {
                            form.classList.add('active');
                        }
                    });
                });

                console.log('‚úÖ All UI handlers initialized');
            };
            
            // Start the initialization process
            initializeUIHandlers();
            
            // Restore panel state
            setTimeout(() => {
                const controlPanelCollapsed = localStorage.getItem('controlPanelCollapsed') === 'true';
                
                if (controlPanelCollapsed) {
                    const controlPanel = document.getElementById('control-panel');
                    const panelToggle = document.getElementById('panel-toggle');
                    
                    if (controlPanel && panelToggle) {
                        controlPanel.classList.add('collapsed');
                        const toggleIcon = panelToggle.querySelector('.toggle-icon');
                        if (toggleIcon) toggleIcon.textContent = '+';
                        panelToggle.setAttribute('aria-expanded', 'false');
                    }
                }
            }, 200);
        });
    </script>

    <!-- Service Worker Registration (Optional for PWA features) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Uncomment to enable service worker
                // navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>
